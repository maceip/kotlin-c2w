name: Android CI

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

env:
  # Pre-built assets from assets-v1 release
  ALPINE_AOT_URL: "https://github.com/maceip/kotlin-c2w/releases/download/assets-v1/alpine.aot"
  ALPINE_WASM_URL: "https://github.com/maceip/kotlin-c2w/releases/download/assets-v1/alpine.wasm"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: Install NDK
      run: |
        sdkmanager --install "ndk;27.2.12479018"

    - name: Download pre-built AOT binary
      run: |
        mkdir -p android-app-wamr/app/src/main/assets

        echo "Downloading alpine.aot (pre-compiled ARM64 native code)..."
        curl -fsSL -o android-app-wamr/app/src/main/assets/alpine.aot "$ALPINE_AOT_URL"

        echo "Downloading alpine.wasm (fallback)..."
        curl -fsSL -o android-app-wamr/app/src/main/assets/alpine.wasm "$ALPINE_WASM_URL"

        echo "Assets downloaded:"
        ls -lh android-app-wamr/app/src/main/assets/

    - name: Build WAMR Android APK
      run: |
        cd android-app-wamr
        chmod +x gradlew
        ./gradlew assembleDebug

    - name: Verify APK contents
      run: |
        echo "APK contents:"
        unzip -l android-app-wamr/app/build/outputs/apk/debug/app-debug.apk | grep -E "\.so|\.wasm|\.aot|classes"

        # Verify native library exists
        if ! unzip -l android-app-wamr/app/build/outputs/apk/debug/app-debug.apk | grep -q "libc2w_wamr.so"; then
          echo "ERROR: APK missing native library libc2w_wamr.so"
          exit 1
        fi

        # Verify AOT binary exists
        if ! unzip -l android-app-wamr/app/build/outputs/apk/debug/app-debug.apk | grep -q "alpine.aot"; then
          echo "ERROR: APK missing alpine.aot"
          exit 1
        fi

        # Check APK size (should be >80MB with bundled assets)
        APK_SIZE=$(stat -c%s android-app-wamr/app/build/outputs/apk/debug/app-debug.apk)
        echo "APK size: $((APK_SIZE / 1024 / 1024)) MB"
        if [ "$APK_SIZE" -lt 80000000 ]; then
          echo "ERROR: APK too small ($APK_SIZE bytes) - assets likely missing"
          exit 1
        fi

    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: c2w-wamr-debug
        path: android-app-wamr/app/build/outputs/apk/debug/app-debug.apk

  # Emulator test to verify APK doesn't crash on launch
  test-emulator:
    needs: build
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Download APK
      uses: actions/download-artifact@v4
      with:
        name: c2w-wamr-debug
        path: ./

    - name: Enable KVM
      run: |
        echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
        sudo udevadm control --reload-rules
        sudo udevadm trigger --name-match=kvm

    - name: AVD cache
      uses: actions/cache@v4
      id: avd-cache
      with:
        path: |
          ~/.android/avd/*
          ~/.android/adb*
        key: avd-api-30-x86_64

    - name: Run emulator smoke test
      uses: reactivecircus/android-emulator-runner@v2
      with:
        api-level: 30
        arch: x86_64
        profile: pixel_5
        heap-size: 512M
        ram-size: 4096M
        emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim
        disable-animations: true
        script: |
          echo "=== Installing APK ==="
          adb install app-debug.apk

          echo "=== Launching app ==="
          adb shell am start -n com.example.c2wdemo/.MainActivity

          echo "=== Waiting for app to initialize (15s) ==="
          sleep 15

          echo "=== Checking if app is running ==="
          if adb shell pidof com.example.c2wdemo > /dev/null; then
            echo "SUCCESS: App is running (PID: $(adb shell pidof com.example.c2wdemo))"

            echo "=== Native runtime logs ==="
            adb logcat -d | grep -i "c2w_wamr" | tail -30

            echo "=== App loaded successfully ==="
          else
            echo "FAILURE: App crashed or not running"

            echo "=== Crash logs ==="
            adb logcat -d | grep -iE "(fatal|crash|exception|c2w|wamr)" | tail -100

            exit 1
          fi

          # Screenshot for manual verification
          adb shell screencap -p /sdcard/screenshot.png
          adb pull /sdcard/screenshot.png ./screenshot.png || true

    - name: Upload screenshot
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: emulator-screenshot
        path: screenshot.png
        if-no-files-found: ignore

  # Release job - only runs on tags AND after tests pass
  release:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [build, test-emulator]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Download APK
      uses: actions/download-artifact@v4
      with:
        name: c2w-wamr-debug
        path: ./

    - name: Get APK info
      id: apk-info
      run: |
        APK_SIZE=$(stat -c%s app-debug.apk)
        echo "size=$((APK_SIZE / 1024 / 1024))MB" >> $GITHUB_OUTPUT

    - name: Rename APK for release
      run: |
        mv app-debug.apk c2w-wamr-${{ github.ref_name }}.apk

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: c2w-wamr-${{ github.ref_name }}.apk
        body: |
          ## c2w WAMR Android App ${{ github.ref_name }}

          **Alpine Linux running on Android via WebAssembly**

          ### Features
          - WAMR native runtime (10-15x faster than Java interpreter)
          - AOT-compiled Bochs x86 emulator
          - Checkpoint/snapshot restore for instant boot
          - SIMD acceleration

          ### APK Size
          ${{ steps.apk-info.outputs.size }}

          ### Requirements
          - Android 8.0+ (API 26)
          - ARM64 device

          ### Verified
          - Emulator smoke test passed
          - Native library present
          - AOT binary bundled
        generate_release_notes: true
