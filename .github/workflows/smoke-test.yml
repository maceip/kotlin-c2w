name: Smoke Test (On-Demand)

# Remote agents trigger this with:
#   gh workflow run smoke-test.yml --repo maceip/kotlin-c2w -f ref=master
# Or via API:
#   curl -X POST -H "Authorization: token $GH_TOKEN" \
#     https://api.github.com/repos/maceip/kotlin-c2w/actions/workflows/smoke-test.yml/dispatches \
#     -d '{"ref":"master"}'

on:
  workflow_dispatch:
    inputs:
      ref:
        description: 'Branch or commit to test'
        default: 'master'
        type: string

permissions:
  contents: read

jobs:
  build:
    name: Build APKs
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref }}
          submodules: recursive

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'

      - uses: android-actions/setup-android@v3

      - name: Install NDK
        run: sdkmanager --install "ndk;27.2.12479018"

      - name: Verify libriscv submodule
        run: |
          test -f vendor/libriscv/lib/CMakeLists.txt || {
            echo "ERROR: libriscv submodule not initialized"
            exit 1
          }

      - name: Verify rootfs.tar asset
        run: |
          test -f android-app-wamr/app/src/main/assets/rootfs.tar || {
            echo "ERROR: rootfs.tar not found in assets"
            exit 1
          }
          # Verify it's a valid tar with expected Alpine files
          tar tf android-app-wamr/app/src/main/assets/rootfs.tar | grep -q 'bin/busybox' || {
            echo "ERROR: rootfs.tar does not contain bin/busybox"
            exit 1
          }

      - uses: gradle/actions/setup-gradle@v4

      - name: Build debug + test APKs
        working-directory: android-app-wamr
        run: chmod +x ./gradlew && ./gradlew :app:assembleDebug :app:assembleDebugAndroidTest --no-daemon

      - name: Verify native lib in APK
        run: |
          APK=$(find android-app-wamr/app/build/outputs/apk/debug -name '*.apk' | head -1)
          unzip -l "$APK" | grep libfriscy_android.so || {
            echo "ERROR: libfriscy_android.so not found in APK"
            exit 1
          }

      - uses: actions/upload-artifact@v4
        with:
          name: smoke-apk
          path: android-app-wamr/app/build/outputs/apk/debug/*.apk

      - uses: actions/upload-artifact@v4
        with:
          name: test-apk
          path: android-app-wamr/app/build/outputs/apk/androidTest/debug/*.apk

  smoke:
    needs: build
    uses: maceip/.github/.github/workflows/smoke-test.yml@main
    with:
      apk-artifact-name: smoke-apk
      package-name: com.example.c2wdemo.wamr
      main-activity: com.example.c2wdemo.ImagePickerActivity

  instrumented-test:
    name: Instrumented Runtime Tests
    needs: [build, smoke]
    runs-on: self-hosted
    concurrency: emulator
    env:
      ANDROID_HOME: /opt/android-sdk
    steps:
      - name: Add platform-tools to PATH
        run: echo "$ANDROID_HOME/platform-tools" >> "$GITHUB_PATH"

      - uses: actions/download-artifact@v4
        with:
          name: smoke-apk
          path: apk

      - uses: actions/download-artifact@v4
        with:
          name: test-apk
          path: test-apk

      - name: Wait for device
        run: adb wait-for-device && adb shell getprop ro.build.version.sdk
        timeout-minutes: 2

      - name: Install app APK
        run: adb install -r apk/*.apk

      - name: Install test APK
        run: adb install -r test-apk/*.apk

      - name: Run instrumented tests
        run: |
          adb shell am instrument -w \
            -e class com.example.c2wdemo.FriscyRuntimeInstrumentationTest \
            com.example.c2wdemo.wamr.test/androidx.test.runner.AndroidJUnitRunner \
            | tee test-output.txt

          # Fail if any test failed or the runner errored
          if grep -q 'FAILURES!!!' test-output.txt; then
            echo "::error::Instrumented tests failed"
            exit 1
          fi
          if grep -q 'INSTRUMENTATION_STATUS_CODE: -1' test-output.txt; then
            echo "::error::One or more tests failed"
            exit 1
          fi
          echo "All instrumented tests passed"
        timeout-minutes: 5

      - name: Uninstall test packages
        if: always()
        run: |
          adb uninstall com.example.c2wdemo.wamr.test || true
          adb uninstall com.example.c2wdemo.wamr || true
